<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brick Simulation</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Canvas 요소 생성 및 준비를 위한 스크립트 -->
    <script>
        // 브라우저 프리뷰 iframe 문제를 해결하기 위한 초기 설정
        window.canvasDebug = {
            creationTime: new Date().toISOString(),
            log: []
        };
        
        // 로그 추가 함수
        window.logCanvasInfo = function(message) {
            if (window.canvasDebug) {
                const timeStamp = new Date().toISOString();
                const logEntry = timeStamp + ': ' + message;
                window.canvasDebug.log.push(logEntry);
                console.log('[Canvas Debug]', message);
            }
        };
        
        // 에러 메시지 표시 함수
        window.showError = function(message) {
            console.error('[ERROR]', message);
            const errorElement = document.getElementById('error-message');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                // 로딩 오버레이 숨김
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            } else {
                alert(message);
            }
        };
        
        // 페이지 로드 시작 로그
        window.logCanvasInfo('페이지 로드 시작');
    </script>
</head>
<body>
    <div class="game-container">
        <canvas id="game-canvas" width="800" height="600"></canvas>
        <div id="loading-overlay">
            <div id="loading-text">Loading Brick Simulation...</div>
            <div class="spinner"></div>
        </div>
    </div>
    
    <!-- Canvas 디버깅 및 초기화를 위한 인라인 스크립트 -->
    <script>
        // 즉시 실행되는 스크립트로 Canvas 요소 처리
        (function() {
            window.logCanvasInfo('인라인 스크립트 실행 - DOM 상태: ' + document.readyState);
            
            // 캔버스 초기화 및 등록
            function initCanvas() {
                // Canvas 등록 시도
                console.log('[Canvas Debug] Canvas 확인 시도 #1');
                const canvas = document.getElementById('game-canvas');
                
                if (canvas) {
                    // 전역 변수에 저장
                    window.gameCanvas = canvas;
                    
                    // 캐스캐이드 특수 객체에도 등록
                    window.__cascade_canvas = canvas;
                    
                    console.log(`[Canvas Debug] Canvas 요소 발견: ${canvas.id} (${canvas.width}x${canvas.height})`);
                    console.log('[Canvas Debug] Canvas 요소가 window.gameCanvas에 등록됨');
                    console.log('[Canvas Debug] Canvas 요소가 window.__cascade_canvas에도 등록됨');
                    console.log('[Canvas Debug] Canvas 요소 초기화 성공!');
                    return true;
                } else {
                    console.error('[Canvas Debug] ERROR: game-canvas를 찾을 수 없습니다!');
                    return false;
                }
            }
            
            // 게임 초기화 함수
            function initGame() {
                console.log('[Game Debug] 게임 초기화 시작...');
                console.log('[Game Debug] 현재 시간:', new Date().toISOString());
                console.log('[Game Debug] 문서 상태:', document.readyState);
                
                try {
                    if (initCanvas()) {
                        const canvas = window.gameCanvas;
                        console.log('[Game Debug] Canvas 초기화 성공');
                        
                        // 스크립트 로딩 확인
                        console.log('[Game Debug] 필수 클래스 확인:');
                        
                        // 개별 스크립트 파일 로딩 상태 확인
                        console.log('[Game Debug] 스크립트 파일 로딩 상태 확인:');
                        const scripts = document.scripts;
                        const loadedScripts = [];
                        for (let i = 0; i < scripts.length; i++) {
                            if (scripts[i].src && scripts[i].src.includes('/blog/brick_sim_js/js/')) {
                                const scriptPath = scripts[i].src;
                                const scriptName = scriptPath.split('/').pop();
                                const isLoaded = scripts[i].readyState ? scripts[i].readyState === 'loaded' || scripts[i].readyState === 'complete' : true;
                                console.log(`- 스크립트 ${scriptName}: ${isLoaded ? '로드됨' : '로드 안됨'} (${scriptPath})`);
                                loadedScripts.push({ name: scriptName, loaded: isLoaded, path: scriptPath });
                            }
                        }
                        
                        // 각 클래스 로딩 상태 자세히 확인
                        const inputManagerLoaded = typeof InputManager !== 'undefined';
                        const assetManagerLoaded = typeof AssetManager !== 'undefined';
                        const levelManagerLoaded = typeof LevelManager !== 'undefined';
                        const uiManagerLoaded = typeof UIManager !== 'undefined';
                        const collisionManagerLoaded = typeof CollisionManager !== 'undefined';
                        const gameLoaded = typeof Game !== 'undefined';

                        // 상세 로딩 상태 및 추가 정보 로깅
                        console.log('[Game Debug] 클래스 로딩 상세 정보:');
                        console.log('- InputManager 정의됨:', inputManagerLoaded, inputManagerLoaded ? '✓' : '✗');
                        console.log('- AssetManager 정의됨:', assetManagerLoaded, assetManagerLoaded ? '✓' : '✗');
                        console.log('- LevelManager 정의됨:', levelManagerLoaded, levelManagerLoaded ? '✓' : '✗');
                        console.log('- UIManager 정의됨:', uiManagerLoaded, uiManagerLoaded ? '✓' : '✗');
                        console.log('- CollisionManager 정의됨:', collisionManagerLoaded, collisionManagerLoaded ? '✓' : '✗');
                        console.log('- Game 정의됨:', gameLoaded, gameLoaded ? '✓' : '✗');
                        
                        // 로드되지 않은 클래스 목록 생성
                        const notLoadedClasses = [];
                        if (!inputManagerLoaded) notLoadedClasses.push('InputManager');
                        if (!assetManagerLoaded) notLoadedClasses.push('AssetManager');
                        if (!levelManagerLoaded) notLoadedClasses.push('LevelManager');
                        if (!uiManagerLoaded) notLoadedClasses.push('UIManager');
                        if (!collisionManagerLoaded) notLoadedClasses.push('CollisionManager');
                        if (!gameLoaded) notLoadedClasses.push('Game');
                        
                        if (notLoadedClasses.length > 0) {
                            console.error('[Game Debug] 로드되지 않은 클래스 목록:', notLoadedClasses.join(', '));
                            throw new Error('필수 클래스가 로드되지 않았습니다. 스크립트 로딩 순서를 확인하세요. 로드되지 않은 클래스: ' + notLoadedClasses.join(', '));
                        }
                        
                        // 에셋 경로 설정 - 상대 경로가 아닌 절대 경로로 수정
                        const imageAssets = {
                            'paddle': '/blog/brick_sim_js/assets/images/paddle.png',
                            'ball': '/blog/brick_sim_js/assets/images/ball.png',
                            'brick_normal': '/blog/brick_sim_js/assets/images/brick_normal.png',
                            'brick_strong': '/blog/brick_sim_js/assets/images/brick_strong.png',
                            'brick_unbreakable': '/blog/brick_sim_js/assets/images/brick_unbreakable.png',
                            'item_extend': '/blog/brick_sim_js/assets/images/item_extend.png',
                            'item_life': '/blog/brick_sim_js/assets/images/item_life.png',
                            'item_multi': '/blog/brick_sim_js/assets/images/item_multi.png',
                            'item_slow': '/blog/brick_sim_js/assets/images/item_slow.png',
                            'background': '/blog/brick_sim_js/assets/images/background.png'
                        };
                        
                        const audioAssets = {
                            'paddle_hit': '/blog/brick_sim_js/assets/sounds/paddle_hit.mp3',
                            'brick_hit': '/blog/brick_sim_js/assets/sounds/brick_hit.mp3',
                            'brick_break': '/blog/brick_sim_js/assets/sounds/brick_break.mp3',
                            'item_collect': '/blog/brick_sim_js/assets/sounds/item_collect.mp3',
                            'level_complete': '/blog/brick_sim_js/assets/sounds/level_complete.mp3',
                            'game_over': '/blog/brick_sim_js/assets/sounds/game_over.mp3',
                            'life_lost': '/blog/brick_sim_js/assets/sounds/life_lost.mp3'
                        };

                        window.game = new Game(canvas);
                        console.log('[Game Debug] 게임 인스턴스 생성 완료');
                        
                        // 에셋 로드 콜백 설정
                        if (window.game.assetManager) {
                            window.game.assetManager.setCallbacks(
                                (progress) => {
                                    console.log(`[Asset Manager] 로딩 진행률: ${progress}%`);
                                },
                                () => {
                                    console.log('[Asset Manager] 모든 에셋 로드 완료');
                                    window.game.start();
                                    console.log('[Game Debug] 게임 시작 완료!');
                                }
                            );
                            
                            // 에셋 로드 시작
                            console.log('[Asset Manager] 에셋 로드 시작...');
                            window.game.assetManager.loadImages(imageAssets);
                            window.game.assetManager.loadAudio(audioAssets);
                        } else {
                            console.error('[Game Debug] 에셋 매니저가 초기화되지 않았습니다');
                            window.game.start();
                            console.log('[Game Debug] 에셋 매니저 없이 게임 시작 시도!');
                        }
                    } else {
                        console.error('[Game Debug] Canvas 초기화 실패');
                        window.showError('캔버스를 초기화할 수 없습니다. 브라우저가 HTML5 Canvas를 지원하는지 확인하세요.');
                    }
                } catch (error) {
                    console.error('[Game Debug] 게임 초기화 중 오류 발생:', error);
                    window.showError(`게임 초기화 중 오류: ${error.message}`);
                }
            }
            
            // 초기화는 모든 스크립트가 로드된 후에 진행
            // 캔버스만 먼저 초기화
            initCanvas();
            
            // DOM 로드 후 한번 더 확인
            let checkAttempts = 0;
            const maxAttempts = 10;
            
            // Canvas 생성 함수 정의
            function createCanvasIfNeeded() {
                if (!window.gameCanvas) {
                    const canvas = document.getElementById('game-canvas');
                    if (canvas) {
                        window.gameCanvas = canvas;
                        window.logCanvasInfo('createCanvasIfNeeded: Canvas 생성 성공');
                        return true;
                    } else {
                        window.logCanvasInfo('createCanvasIfNeeded: Canvas 요소를 찾을 수 없음');
                        return false;
                    }
                }
                return true;
            }
            
            // Canvas 전역 등록 함수 정의
            function registerCanvasGlobally() {
                if (window.gameCanvas) {
                    window.__cascade_canvas = window.gameCanvas;
                    window.logCanvasInfo('registerCanvasGlobally: Canvas가 전역에 등록됨');
                    return true;
                }
                return false;
            }
            
            let canvasCheck = setInterval(function() {
                checkAttempts++;
                window.logCanvasInfo('Canvas 확인 시도 #' + checkAttempts);
                
                if (createCanvasIfNeeded() && registerCanvasGlobally()) {
                    window.logCanvasInfo('Canvas 요소 초기화 성공!');
                    clearInterval(canvasCheck);
                } else if (checkAttempts >= maxAttempts) {
                    window.logCanvasInfo('Canvas 초기화 시도 횟수 초과 (' + maxAttempts + ')');
                    clearInterval(canvasCheck);
                }
            }, 300);
        })();
    </script>
    
    <div id="error-message" class="error-message">
        Failed to load the game. Please make sure your browser supports Canvas and JavaScript.
    </div>
    
    <div class="controls">
        <h2>Controls</h2>
        <table class="controls-table">
            <tr>
                <td class="key">Left/Right Arrow Keys</td>
                <td>Move the paddle</td>
            </tr>
            <tr>
                <td class="key">Space</td>
                <td>Start game / Launch ball</td>
            </tr>
            <tr>
                <td class="key">P</td>
                <td>Pause / Resume</td>
            </tr>
            <tr>
                <td class="key">Enter</td>
                <td>Restart after Game Over</td>
            </tr>
            <tr>
                <td class="key">Esc</td>
                <td>Quit game</td>
            </tr>
        </table>
    </div>

    <!-- Game Scripts -->
    <!-- 1. 유틸리티와 설정 파일 로드 -->
    <script src="js/config.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/physics.js"></script>
    
    <!-- 2. 게임 오브젝트 및 컴포넌트 -->
    <script src="js/components/gameObject.js"></script>
    <script src="js/components/paddle.js"></script>
    <script src="js/components/ball.js"></script>
    <script src="js/components/brick.js"></script>
    <script src="js/components/item.js"></script>
    <script src="js/components/level.js"></script>
    
    <!-- 3. UI 컴포넌트 로드 -->
    <script src="js/ui/text.js"></script>
    <script src="js/ui/hud.js"></script>
    <script src="js/ui/menu.js"></script>
    
    <!-- 4. 매니저 클래스 로드 -->
    <script src="js/managers/inputManager.js"></script>
    <script src="js/managers/assetManager.js"></script>
    <script src="js/managers/collisionManager.js"></script>
    <script src="js/managers/scoreManager.js"></script>
    <script src="js/managers/levelManager.js"></script>
    <script src="js/ui/uiManager.js"></script>
    
    <!-- 5. 메인 게임 클래스 -->
    <script src="js/game.js"></script>
    
    <!-- 클래스 로딩 상태 확인을 위한 스크립트 -->
    <script>
        // 클래스 로딩 상태 확인
        console.log('[디버그] 클래스 접근 방식 확인...');
        
        // 클래스의 상태를 자세히 기록하는 함수
        window.checkClass = function(name) {
            // 여러 다른 방식으로 확인
            const inWindow = window[name] !== undefined;
            const inGlobal = typeof window[name] !== 'undefined';
            const evalCheck = (() => {
                try {
                    return eval('typeof ' + name + ' !== "undefined"');
                } catch (e) {
                    return false;
                }
            })();
            
            console.log(`[디버그] ${name}: window[name]=${inWindow}, typeof=${inGlobal}, eval=${evalCheck}`);
            return inWindow || inGlobal || evalCheck;
        };
        
        // 각 클래스를 전역으로 등록 시도
        window.requiredClasses = [
            'InputManager', 'AssetManager', 'LevelManager', 
            'UIManager', 'CollisionManager', 'Game'
        ];
        
        // 현재 클래스 로딩 상태 확인
        console.log('[디버그] 클래스 로딩 상태 초기 확인');
        
        // 나중에 로드된 파일이 해당 클래스를 글로벌에 등록하게 됩니다.
        console.log('[디버그] 클래스 로딩 상태 확인 완료');
    </script>
    
    <!-- 스크립트 로딩 확인 및 게임 초기화 -->
    <script>
        // 전역 객체에 클래스 등록 함수
        function registerGlobalClass(localClass, className) {
            if (typeof localClass === 'function') {
                window[className] = localClass;
                console.log(`[디버그] ${className} 클래스를 전역 객체에 등록했습니다`);
                return true;
            }
            return false;
        }
        
        // 클래스 로드 상태 확인 및 디버깅 함수
        function checkAndDebugClasses() {
            console.log("===== 스크립트 로딩 상태 확인 (수정됨) =====");
            
            // 필요한 클래스 목록
            const requiredClasses = [
                'InputManager', 'AssetManager', 'LevelManager',
                'UIManager', 'CollisionManager', 'Game'
            ];
            
            // 각 클래스 로드 상태 확인 (다양한 방법으로)
            const classStatus = {};
            const missingClasses = [];
            
            requiredClasses.forEach(className => {
                // 여러 방식으로 클래스 존재 확인
                const directCheck = typeof window[className] !== 'undefined';
                const evalCheck = (function() {
                    try { return eval('typeof ' + className + ' !== "undefined"'); }
                    catch(e) { return false; }
                })();
                
                classStatus[className] = directCheck || evalCheck;
                console.log(`${className} 로드됨:`, classStatus[className], 
                            `(direct: ${directCheck}, eval: ${evalCheck})`);
                
                if (!classStatus[className]) {
                    missingClasses.push(className);
                }
            });
            
            console.log("====================================");
            
            // 누락된 클래스가 있는 경우 원인 파악
            if (missingClasses.length > 0) {
                console.error("[디버그] 로드되지 않은 클래스:", missingClasses.join(', '));
                
                // 스크립트 로드 상태 확인
                console.log("===== 스크립트 파일 로드 상태 확인 =====");
                const scripts = document.querySelectorAll('script[src]');
                scripts.forEach(script => {
                    if (script.src && script.src.includes('js/')) {
                        const scriptPath = script.src;
                        const scriptName = scriptPath.split('/').pop();
                        console.log(`${scriptName}: ${scriptPath} - 로드${script.complete ? '완료' : '중'}`);
                        
                        // 네트워크 접근 가능 여부 테스트
                        fetch(scriptPath + '?check=' + new Date().getTime())
                            .then(response => {
                                console.log(`${scriptName} 리소스 접근 가능 (Status: ${response.status})`);
                            })
                            .catch(error => {
                                console.error(`${scriptName} 리소스 접근 불가능: ${error}`);
                            });
                    }
                });
                console.log("====================================");
                return false;
            }
            return true;
        }
        
        // 페이지 로드 완료 후 실행
        window.addEventListener('load', function() {
            console.log('[디버그] 전체 페이지 로드 완료 - 게임 초기화 준비 중...');
            
            // 스크립트 지연 로드 문제 해결을 위해 약간의 시간 지연 후 초기화
            setTimeout(function() {
                try {
                    console.log('[디버그] 클래스 로드 상태 최종 확인...');
                    
                    // 클래스 로드 상태 확인
                    const allClassesLoaded = checkAndDebugClasses();
                    
                    if (allClassesLoaded) {
                        console.log('[디버그] 모든 클래스가 정상적으로 로드되었습니다. 게임을 초기화합니다.');
                        initGame(); // 게임 초기화
                    } else {
                        console.error('[디버그] 일부 클래스가 로드되지 않았습니다. 게임을 초기화할 수 없습니다.');
                        alert('게임 초기화 오류: 필수 클래스가 로드되지 않았습니다. 콘솔을 확인해주세요.');
                    }
                } catch (error) {
                    console.error('[디버그] 게임 초기화 중 예외 발생:', error);
                    alert('게임 초기화 중 오류 발생: ' + error.message);
                }
            }, 1500); // 1.5초 대기 (스크립트 로드에 충분한 시간 제공)
        });
    </script>
    
    <script src="js/main.js"></script>
    
    <!-- 모든 스크립트 로드 후 게임 초기화 -->
    <script>
        // 페이지가 완전히 로드된 후 게임 초기화 실행
        window.addEventListener('load', function() {
            console.log('==========================================');
            console.log('페이지 로드 완료, 게임 초기화 시작');
            console.log('==========================================');
            
            // 로드된 클래스 확인
            const requiredClasses = [
                'InputManager', 'AssetManager', 'LevelManager', 
                'UIManager', 'CollisionManager', 'Game'
            ];
            
            const missingClasses = [];
            requiredClasses.forEach(className => {
                const isLoaded = typeof window[className] !== 'undefined';
                console.log(`${className} 로드 상태: ${isLoaded ? '✓' : '✗'}`);
                if (!isLoaded) missingClasses.push(className);
            });
            
            if (missingClasses.length > 0) {
                console.error('아직 로드되지 않은 클래스가 있습니다:', missingClasses.join(', '));
            } else {
                console.log('모든 클래스가 성공적으로 로드되었습니다!');
                // 게임 초기화 함수 호출
                if (typeof initGame === 'function') {
                    try {
                        initGame();
                        console.log('게임 초기화 성공!');
                    } catch (e) {
                        console.error('게임 초기화 중 오류 발생:', e);
                    }
                } else {
                    console.error('initGame 함수를 찾을 수 없습니다');
                }
            }
        });
    </script>
</body>
</html>
